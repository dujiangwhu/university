Ext.define('KitchenSink.view.enrollmentManagement.applicationForm.SiampleAuditAppFormPanel', {    extend: 'Ext.panel.Panel',    xtype: 'SiampleAuditAppFormPanel',    controller: 'SiampleAuditApplicationForm',    requires: [        'Ext.data.*',        'Ext.grid.*',        'Ext.util.*',        'Ext.toolbar.Paging',        'Ext.ux.ProgressBarPager',        'KitchenSink.view.enrollmentManagement.applicationForm.dynamicInfo.dynamicAttributeForm',        'KitchenSink.view.enrollmentManagement.applicationForm.SiampleAuditApplicationFormController',        'KitchenSink.view.enrollmentManagement.applicationForm.auditFormFileCheckStore',        'KitchenSink.view.enrollmentManagement.applicationForm.referenceLetterStore',        'KitchenSink.view.enrollmentManagement.applicationForm.LcJgStore',        'KitchenSink.view.enrollmentManagement.applicationForm.fileStore'    ],    title: '申请材料查看',    bodyStyle:'overflow-y:auto;overflow-x:hidden',    constructor: function (obj){        this.appInsID=String(obj.appInsID);        this.applicationFormTagStore=obj.applicationFormTagStore;        this.gridRecord=obj.gridRecord;        this.callParent();    },    initComponent: function(){        var me = this;        var applicationFormTagStore=this.applicationFormTagStore;        var auditApplicationFormPanel = {            auditFormFileCheckAuditStateStore:new KitchenSink.view.common.store.appTransStore("TZ_BMB_DJWJSPZT"),            auditRefLetterStateStore:new KitchenSink.view.common.store.appTransStore("TZ_APPFORM_STATE"),            auditFormFileCheckBackMsgStore :new KitchenSink.view.common.store.comboxStore({                recname:'TZ_CLS_HFDY_T',                condition:{TZ_CLASS_ID:{                    value:'',                    operator:'01',                    type:'01'                },TZ_SBMINF_ID:{                    value:'',                    operator:'01',                    type:'01'                }},                result:'TZ_SBMINF_REP'            }),            colorSortStore :new KitchenSink.view.common.store.comboxStore({                recname:'TZ_FORM_COLOR_V',                condition:{TZ_JG_ID:{                    value:Ext.tzOrgID,                    operator:'01',                    type:'01'                },TZ_APP_INS_ID:{                    value:String(this.appInsID),                    operator:'01',                    type:'01'                }},                result:'TZ_COLOR_SORT_ID,TZ_COLOR_NAME,TZ_COLOR_CODE'            })        };        Ext.apply(this,{            auditApplicationFormPanel:auditApplicationFormPanel,            items: [                {                    xtype: 'form',                    reference: 'auditApplicationForm',                    layout: {                        type: 'vbox',                        align: 'stretch'                    },                    border: false,                    bodyPadding: 10,                    //heigth: 600,                    bodyStyle:'overflow-y:auto;overflow-x:hidden',                    fieldDefaults: {                        msgTarget: 'side',                        labelWidth: 100,                        labelStyle: 'font-weight:bold'                    },                    items: [{                        xtype: 'textfield',                        name: 'classID',                        hidden:true                    },{                        xtype: 'textfield',                        name: 'oprID',                        hidden:true                    },{                        xtype: 'textfield',                        name: 'remark',                        hidden:true                    },{                        xtype: 'textfield',                        fieldLabel: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.name","姓名"),                        name: 'stuName',                        cls:'lanage_1',                        readOnly:true                    }, {                        xtype: 'textfield',                        fieldLabel: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.className","班级名称"),                        name: 'className',                        cls:'lanage_1',                        readOnly:true                    },{                        xtype: 'textfield',                        fieldLabel: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.appInsID","报名表编号"),                        name: 'appInsID',                        cls:'lanage_1',                        readOnly:true,                        beforeBodyEl: [                            '<li id="{id}-viewAppFormEl" data-ref="viewAppFormEl" class="x-tagfield-item x-tagfield-item-selected" style="cursor:pointer;margin-top:4px;position:absolute">' +                                '<div  class="'+                                'x-tagfield-item-text" style="padding-right:4px;">'+Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.viewApplicationForm","查看报名表")+'</div>' +                                '</li>'                        ],                        childEls: [                            'viewAppFormEl'                        ],                        listeners:{                            change:function(field){                                var appInsID = field.getValue();                                if(appInsID){                                    var length = appInsID.length;                                    if(length>0){                                        var viewAppFormEl = this.viewAppFormEl;                                        if (viewAppFormEl) {                                            var tpl = Ext.create('Ext.XTemplate',                                                'margin-left: {width}px;'                                            );                                            var data = {                                                width: 34+length*8                                            };                                            var marginLeftStyle = tpl.apply(data);                                            viewAppFormEl.applyStyles(marginLeftStyle);                                            viewAppFormEl.addListener("click","viewApplicationForm");                                        }                                    }                                }                            }                        }                    }, {                        xtype: 'combobox',                        fieldLabel: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.appFormState","报名表状态"),                        editable:false,                        name: 'appFormState',                        valueField: 'TValue',                        displayField: 'TSDesc',                        store: new KitchenSink.view.common.store.appTransStore("TZ_APPFORM_STATE") ,                        queryMode: 'local',                        triggerAction: 'all'                    }, {                        xtype: 'combobox',                        fieldLabel: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.auditState","评审状态"),                        name: 'auditState',                        editable:false,                                                valueField: 'TValue',                        displayField: 'TSDesc',                        store: new KitchenSink.view.common.store.appTransStore("TZ_AUDIT_STATE"),                        queryMode: 'local',                        triggerAction: 'all'                                          }, {                        xtype: 'tagfield',                        fieldLabel:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.tag","标签"),                        name: 'tag',                        store:applicationFormTagStore,                        valueField: 'TZ_LABEL_ID',                        displayField: 'TZ_LABEL_NAME',                        filterPickList:true,                        /*createNewOnEnter: true,                        createNewOnBlur: true,*/                        queryMode: 'local',                                                /*listeners:{                            'select': function(combo,record,index,eOpts)//匹配下拉值之后置空输入文字                            {                                var me = this;                                me.inputEl.dom.value = "";                            }                        }*/                    }, {                        xtype: 'combobox',                        fieldLabel:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.colorType","类别"),                        name: 'colorType',                        emptyText:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.pleaseSelect","请选择..."),                        queryMode:'local',                        valueField: 'TZ_COLOR_SORT_ID',                        displayField: 'TZ_COLOR_NAME',                        triggerAction: 'all',                        /*triggers:{                            clear: {                                cls: 'x-form-clear-trigger',                                handler: function(field){                                    field.setValue("");                                }                            }                        },*/                        editable : false,                        fieldStyle:"padding-left: 46px;",                        store:auditApplicationFormPanel.colorSortStore,                        tpl: Ext.create('Ext.XTemplate',                            '<tpl for=".">',                            '<div class="x-boundlist-item"><div class="x-colorpicker-field-swatch-inner" style="margin-top:6px;width:30px;height:50%;background-color: #{TZ_COLOR_CODE}"></div><div style="margin-left:40px;display: block;  overflow:  hidden; white-space: nowrap; -o-text-overflow: ellipsis; text-overflow:  ellipsis;"> {TZ_COLOR_NAME}</div></div>',                            '</tpl>',{}                        ),                        displayTpl: Ext.create('Ext.XTemplate',                            '<tpl for=".">',                            '{TZ_COLOR_NAME}',                            '</tpl>'                        ),                        beforeBodyEl: [                            '<div class="' + Ext.baseCSSPrefix + 'colorpicker-field-swatch" style="margin-left:110px;width:30px;height:50%">' +                                '<div id="{id}-colorEl" data-ref="colorEl" class="' + Ext.baseCSSPrefix +                                'colorpicker-field-swatch-inner"></div>' +                                '</div>'                        ],                        childEls: [                            'colorEl'                        ],                        listeners:{                            change:function(combo, newValue, oldValue, eOpts){                                var colorEl = this.colorEl;                                if(newValue){                                    var rec = auditApplicationFormPanel.colorSortStore.find('TZ_COLOR_SORT_ID',newValue,0,true,true,false);                                    if(rec>-1){                                        var color = auditApplicationFormPanel.colorSortStore.getAt(rec).get("TZ_COLOR_CODE");                                        if (colorEl) {                                            var tpl = Ext.create('Ext.XTemplate',                                                'background: #{alpha};'                                            );                                            var data = {                                                alpha: color                                            }                                            var bgStyle = tpl.apply(data);                                            colorEl.applyStyles(bgStyle);                                        }                                    }                                }else{                                    colorEl.applyStyles( 'background: none');                                }                            }                        }                    }]                }                ,                {                    xtype: 'tabpanel',                    frame: true,                    activeTab: 0,                    plain:false,                    style:'margin:0 10px 0 10px',                    resizeTabs:true,                    defaults :{                        autoScroll: false                    },                    listeners:{                    	afterrender:function(tabPanel, opts){                            /*var queryType;                            var form = tabPanel.findParentByType('SiampleAuditAppFormPanel').child('form').getForm();                            var classID = form.findField('classID').getValue();                            var oprID = form.findField('oprID').getValue();                            var tzStoreParams;                            var refLetterStore = tabPanel.down('grid[name=refLetterGrid]').store;                            var fileStore = tabPanel.down('grid[name=fileGrid]').store;                            if(!refLetterStore.isLoaded()){                                tzStoreParams = '{"classID":"'+classID+'","oprID":"' + oprID + '","queryType":"REFLETTER"}';                                refLetterStore.tzStoreParams = tzStoreParams;                                refLetterStore.load();                            }                            if(!fileStore.isLoaded()){                                tzStoreParams = '{"classID":"'+classID+'","oprID":"' + oprID + '","queryType":"ATTACHMENT"}';                                fileStore.tzStoreParams = tzStoreParams;                                fileStore.load();                            }*/                            /*if(newCard.name == "moreInfoForm"){                                加载更多信息                            }else{                                                               if (newCard.name == "refLetterAndAttachment"){                                    var refLetterStore = newCard.down('grid[name=refLetterGrid]').store;                                    var fileStore = newCard.down('grid[name=fileGrid]').store;                                    if(!refLetterStore.isLoaded()){                                        tzStoreParams = '{"classID":"'+classID+'","oprID":"' + oprID + '","queryType":"REFLETTER"}';                                        refLetterStore.tzStoreParams = tzStoreParams;                                        refLetterStore.load();                                    }                                    if(!fileStore.isLoaded()){                                        tzStoreParams = '{"classID":"'+classID+'","oprID":"' + oprID + '","queryType":"ATTACHMENT"}';                                        fileStore.tzStoreParams = tzStoreParams;                                        fileStore.load();                                    }                                }else if(newCard.name == "LcJgGrid")                                {                                    var store = newCard.store;                                    if(!store.isLoaded()){                                        tzStoreParams = '{"classID":"'+classID+'","oprID":"' + oprID + '","queryType":"' + queryType + '"}';                                        store.tzStoreParams = tzStoreParams;                                        store.load();                                    }                                } else{                                    var store = newCard.store;                                    if(!store.isLoaded()){                                        tzStoreParams = '{"classID":"'+classID+'","oprID":"' + oprID + '","queryType":"' + queryType + '"}';                                        store.tzStoreParams = tzStoreParams;                                        store.load({                                            scope: this,                                            callback: function(records, operation, success) {                                                if(queryType == "FILE")                                                {                                                    auditApplicationFormPanel.auditFormFileCheckBackMsgJsonData =new Array(records.length);                                                }                                            }                                        });                                    }                                }                                this.doLayout();                            }*/                        }                    },                    items:[                                                {                            minHeight:250,                            layout: {                                type: 'accordion',                                animate:true                            },                            tabBar: {                                border: false                            },                            title: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.recommendationAndAttachment","推荐信和附件"),                            name:'refLetterAndAttachment',                            items:[                                {                                    title: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.recommendation","推荐信"),                                    xtype: 'grid',                                    columnLines: true,                                    dockedItems:[{                                        xtype:"toolbar",                                        items:[                                            {text:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.sendRecommendationSubmitStateEmail","发送推荐信未完全提交提醒邮件"),iconCls:"email",handler: "sendRefLetterRemindEmail"}                                        ]                                    }],                                    name: 'refLetterGrid',                                    reference: 'refLetterGrid',                                    plugins: {                                        ptype: 'cellediting',                                        pluginId: 'refLetterCellEditing',                                        clicksToEdit: 1,                                        listeners:{                                            beforeedit:function(editor, context, eOpts){                                                if(context.record.get('refLetterAppInsId')==0){                                                    return false;                                                }                                            }                                        }                                    },                                    store: {                                        type: 'referenceLetterStore'                                    },                                    columns: [                                        {                                            text: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.name","姓名"),                                            dataIndex: 'refLetterPerName',                                            sortable: false,                                            minWidth:90                                        },{                                            text:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.email","邮箱"),                                            dataIndex: 'refLetterPerEmail',                                            sortable: false,                                            flex:1,                                            minWidth:120                                        },{                                            text:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.mobilePhone","手机"),                                            dataIndex: 'refLetterPerPhone',                                            sortable: false,                                            width:120                                        },{                                            //xtype:'linkcolumn',                                            text:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.viewRecommendation","查看推荐信"),                                            sortable:false,//                                            align:'center',//                                            items:[{//                                                text:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.view","查看"),//                                                handler: "viewRefLetter"//                                            }],                                            width:105,                                            renderer:function(){                                                return '<a href="javascript:void(0)" >查看</a>';                                            }                                            ,                                            listeners:{                                                click:'viewRefLetter'                                            }                                        },{                                            text: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.submitState","提交状态"),                                            dataIndex: 'refLetterState',                                            sortable: false,                                            width:100,                                            editor: {                                                editable:false,                                                xtype:"combo",                                                forceSelection: true,                                                valueField: 'TValue',                                                displayField: 'TSDesc',                                                store: auditApplicationFormPanel.auditRefLetterStateStore,                                                queryMode: 'local'                                            },                                            renderer:function(v,metadata,record){                                                if(v){                                                    var rec = auditApplicationFormPanel.auditRefLetterStateStore.find('TValue',v,0,false,true,false);                                                    if(rec>-1){                                                        return auditApplicationFormPanel.auditRefLetterStateStore.getAt(rec).get("TSDesc");                                                    }else{                                                        return "";                                                    }                                                }else{                                                    return "";                                                }                                            }                                        },{                                            text:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.recommendation","推荐信"),                                            sortable: true,                                            dataIndex: 'refLetterFile',                                            minWidth: 150,                                            flex:1,                                            renderer:function(value,metadata,record){                                                var refLetterSysFile = record.get('refLetterSysFile');                                                var refLetterUserFile = record.get('refLetterUserFile');                                                var refAccessUrl = record.get('refLetterAurl');                                                if (refLetterSysFile == "" || refLetterSysFile == null	|| refAccessUrl == "" || refAccessUrl == null){                                                    return Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.recommendation","推荐信");                                                }else{                                                    return '<a href="'+ TzUniversityContextPath + refAccessUrl+'" target="_blank">'+refLetterUserFile+'</a>';                                                }                                            }                                        },{                                            menuDisabled: true,                                            sortable: false,                                            width:60,                                            xtype: 'actioncolumn',                                            align: 'center',                                            items:[                                                {iconCls: 'upload',tooltip: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.upload","上传"), handler: 'uploadRefLetter'},                                                {iconCls: 'remove',tooltip: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.delete","删除"), handler: 'deleteRefLetter'}                                            ]                                        }                                    ]                                },                                {                                    title:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.attachment","附件"),                                    xtype: 'grid',                                    columnLines: true,                                    name: 'fileGrid',                                    reference: 'fileGrid',                                    dockedItems:[{                                        xtype:"toolbar",                                        items:[                                            {text:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.uploadfile","上传附件"),iconCls:"upload",handler: "uploadFiles"}                                        ]                                    }],                                    store: {                                        type: 'uploadFilesStore'                                    },                                    plugins: {                                        ptype: 'cellediting',                                        pluginId: 'attachmentCellEditing',                                        clicksToEdit: 1                                    },                                    listeners:{                                        viewready:function(panel){                                            panel.store.findBy(function(record,id){                                                var itemID = record.get('xuhao');                                                $("a[ref="+itemID+"]").fancybox(                                                    {                                                        prevEffect : 'none',                                                        nextEffect : 'none',                                                        closeBtn  : true,                                                        arrows    : false,                                                        nextClick : true,                                                        helpers : {                                                            thumbs : {                                                                width  : 50,                                                                height : 50                                                            },title : {                                                                type : 'inside'                                                            },                                                            buttons	: {}                                                        }                                                    }                                                );                                            })                                        }                                    },                                    store: {                                        type: 'fileStore'                                    },                                    columns: [{                                        text: "fancyboxId",                                        dataIndex: 'xuhao',                                        hidden:true                                    },{                                        text: "信息项ID",                                        dataIndex: 'TZ_XXX_BH',                                        hidden:true                                    },{                                        text: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.attachmentName","附件名称"),                                        dataIndex: 'TZ_XXX_MC',                                        minWidth:425                                    },{                                        text: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.viewAttachment","查看附件"),                                        dataIndex: 'fileLinkName',                                        minWidth:  200,                                        flex: 1,                                        renderer: function(value,metadata,record) {                                            var strFile = record.get('strfileDate');                                            return strFile;                                        }                                    },{                                        menuDisabled: true,                                        sortable: false,                                        width:60,                                        xtype: 'actioncolumn',                                        text: '操作',                                        align: 'center',                                        items:[                                            {iconCls: 'remove',tooltip:Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_AUDIT_STD.delete","删除"), handler: 'deleteFiles'}                                        ]                                    }                                    ]                                }                            ]                        }]                }]        });        this.callParent();    },    buttons: [{        text: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_STU_STD.save","保存"),        iconCls:"save",        name:'auditAppFormSaveBtn',        handler: 'onAuditApplicationFormSave2'    }, {        text: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_STU_STD.ensure","确定"),        iconCls:"ensure",        name:'auditAppFormEnsureBtn',        handler: 'onAuditApplicationFormSave2'    }, {        text: Ext.tzGetResourse("TZ_BMGL_BMBSH_COM.TZ_BMGL_STU_STD.close","关闭"),        iconCls:"close",        handler: 'onAuditApplicationFormClose'    }]});